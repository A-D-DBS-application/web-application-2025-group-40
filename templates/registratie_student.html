{% extends "base.html" %}

{% block title %}Swipr - Registratie Student{% endblock %}

{% block content %}

{% from '_navbar.html' import navbar %}

{{ navbar(
  variant='student',
  show_brand=True,
  links=[],
  right_buttons=[{'href':'/login_student','label':'Log in','style':'outline'}]
) }}

<div class="container d-flex justify-content-center align-items-center min-vh-100 py-5">
  <div class="card shadow-sm w-100 swipr-auth-card">
    <div class="card-body p-4 p-md-5">

      <h1 class="h4 fw-bold text-swipr-student mb-1">Registratie Student</h1>
      <p class="text-muted mb-4">Maak je studentenaccount aan.</p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{% if category == 'danger' %}danger{% elif category == 'success' %}success{% else %}warning{% endif %} mb-3" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="registerForm" method="POST" action="{{ url_for('registratie_student') }}" novalidate>
        <div class="row g-3">

          <div class="col-12 col-md-6">
            <label for="firstName" class="form-label fw-semibold">Voornaam</label>
            <input type="text" class="form-control" id="firstName" name="firstName"
                   placeholder="Voornaam" required />
            <div class="invalid-feedback">Vul je voornaam in.</div>
          </div>

          <div class="col-12 col-md-6">
            <label for="lastName" class="form-label fw-semibold">Achternaam</label>
            <input type="text" class="form-control" id="lastName" name="lastName"
                   placeholder="Achternaam" required />
            <div class="invalid-feedback">Vul je achternaam in.</div>
          </div>

          <div class="col-12">
            <label for="email" class="form-label fw-semibold">Studenten e-mail</label>
            <input type="email" class="form-control" id="email" name="email"
                   placeholder="bv. rene.vl@ugent.be" required />
            <div class="invalid-feedback" id="emailErrorBs">Gebruik je officiële studenten e-mailadres.</div>
            <div class="form-text">Enkel toegelaten studentendomeinen.</div>
          </div>

          <div class="col-12">
            <label for="password" class="form-label fw-semibold">Wachtwoord</label>
            <input type="password" class="form-control" id="password" name="password"
                   placeholder="Kies een wachtwoord" required />
            <div class="invalid-feedback" id="passwordErrorBs">
              Min. 8 tekens, 1 hoofdletter, 1 cijfer en 1 speciaal teken.
            </div>
          </div>

          <div class="col-12 d-grid mt-2">
            <button type="submit" class="btn btn-swipr-student btn-lg">
              Registreren
            </button>
          </div>

          <div class="col-12 text-center">
            <small class="text-muted">
              Al een account?
              <a href="/login_student" class="text-decoration-none fw-semibold text-swipr-student">Log in</a>
            </small>
          </div>

        </div>
      </form>

    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('registerForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    const allowedDomains = [
      "ugent.be", "student.ugent.be",
      "kuleuven.be", "student.kuleuven.be",
      "hogent.be", "student.hogent.be",
      "vub.be",
      "arteveldehs.be",
      "student.odisee.be",
      "student.uantwerpen.be",
      "student.vives.be",
      "howest.be"
    ];

    // Simpele email regex (we vertrouwen NIET op typeMismatch/checkValidity)
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    const strongPattern = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).{8,}$/;

    function clearMarks(input) {
      input.classList.remove('is-valid', 'is-invalid');
      input.setCustomValidity('');
    }
    function markValid(input) {
      input.classList.remove('is-invalid');
      input.classList.add('is-valid');
      input.setCustomValidity('');
    }
    function markInvalid(input, message) {
      input.classList.remove('is-valid');
      input.classList.add('is-invalid');
      input.setCustomValidity(message || 'invalid');
    }

    function getDomain(v) {
      const at = v.lastIndexOf('@');
      if (at === -1) return '';
      return v.slice(at + 1).trim();
    }

    function isAllowedDomain(domain) {
      // exact: ugent.be
      // of subdomain: student.ugent.be
      return allowedDomains.some(d => domain === d);
    }

    function validateEmail(strict = false) {
      const v = (emailInput.value || '').trim().toLowerCase();

      // tijdens typen: nog geen @ => neutraal
      if (!strict && !v.includes('@')) {
        clearMarks(emailInput);
        return false;
      }

      // tijdens typen: pas “iets doen” als het er uitziet als een volledige email
      if (!strict && !emailPattern.test(v)) {
        clearMarks(emailInput);
        return false;
      }

      // strict (blur/submit): dan echt valideren
      if (strict && !emailPattern.test(v)) {
        markInvalid(emailInput, "Ongeldig e-mailadres");
        return false;
      }

      const domain = getDomain(v);

      if (!isAllowedDomain(domain)) {
        if (strict) markInvalid(emailInput, "Gebruik je officiële studenten e-mailadres");
        else clearMarks(emailInput);
        return false;
      }

      markValid(emailInput);
      return true;
    }

    function validatePassword(strict = false) {
      const value = passwordInput.value || '';

      if (!strict && value.length === 0) {
        clearMarks(passwordInput);
        return false;
      }

      if (!strongPattern.test(value)) {
        if (strict) markInvalid(passwordInput, "Wachtwoord niet sterk genoeg");
        else clearMarks(passwordInput);
        return false;
      }

      markValid(passwordInput);
      return true;
    }

    emailInput.addEventListener('input', () => validateEmail(false));
    emailInput.addEventListener('blur', () => validateEmail(true));

    passwordInput.addEventListener('input', () => validatePassword(false));
    passwordInput.addEventListener('blur', () => validatePassword(true));

    form.addEventListener('submit', function (e) {
      let ok = true;

      // laat bootstrap required velden checken
      if (!form.checkValidity()) ok = false;

      // maar email/password doen we zelf strict
      if (!validateEmail(true)) ok = false;
      if (!validatePassword(true)) ok = false;

      if (!ok) {
        e.preventDefault();
        e.stopPropagation();
      }

      form.classList.add('was-validated');
    });
  })();
</script>

{% endblock %}

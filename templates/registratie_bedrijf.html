{% extends "base.html" %}

{% block title %}Swipr - Registratie Bedrijf{% endblock %}

{% block content %}

{% from '_navbar.html' import navbar %}

{{ navbar(
  variant='bedrijf',
  show_brand=True,
  links=[],
  right_buttons=[{'href':'/login_bedrijf','label':'Log in','style':'outline'}]
) }}

<div class="container d-flex justify-content-center align-items-center min-vh-100 py-5">
  <div class="card shadow-sm w-100 swipr-auth-card">
    <div class="card-body p-4 p-md-5">

      <h1 class="h4 fw-bold text-swipr-bedrijf mb-1">Registratie Bedrijf</h1>
      <p class="text-muted mb-4">Maak een bedrijfsaccount aan.</p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{% if category == 'danger' %}danger{% elif category == 'success' %}success{% else %}warning{% endif %} mb-3" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="registerForm" method="POST" action="{{ url_for('registratie_bedrijf') }}" novalidate>
        <div class="row g-3">

          <div class="col-12">
            <label for="companyName" class="form-label fw-semibold">Bedrijfsnaam</label>
            <input type="text" class="form-control" id="companyName" name="companyName"
                   placeholder="Naam van het bedrijf" required />
            <div class="invalid-feedback">Vul de bedrijfsnaam in.</div>
          </div>

          <div class="col-12">
            <label for="vatNumber" class="form-label fw-semibold">BTW-nummer</label>
            <input type="text" class="form-control" id="vatNumber" name="vatNumber"
                   placeholder="BE0123456789" required />
            <div class="invalid-feedback" id="vatErrorBs">
              BTW-nummer moet beginnen met 'BE' gevolgd door 10 cijfers.
            </div>
            <div class="form-text">Formaat: BE + 10 cijfers</div>
          </div>

          <div class="col-12">
            <label for="email" class="form-label fw-semibold">Zakelijke e-mail</label>
            <input type="email" class="form-control" id="email" name="email"
                   placeholder="bv. info@bedrijf.be" required />
            <div class="invalid-feedback" id="emailErrorBs">
              Gebruik een professioneel bedrijfsdomein (geen gratis provider).
            </div>
          </div>

          <div class="col-12">
            <label for="password" class="form-label fw-semibold">Wachtwoord</label>
            <input type="password" class="form-control" id="password" name="password"
                   placeholder="Kies een wachtwoord" required />
            <div class="invalid-feedback">Vul een wachtwoord in.</div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Contactpersoon</label>
            <div class="row g-2">
              <div class="col-12 col-md-7">
                <input type="text" class="form-control" id="contactName" name="contactName"
                       placeholder="Voornaam Achternaam" required />
                <div class="invalid-feedback">Vul de contactpersoon in.</div>
              </div>
              <div class="col-12 col-md-5">
                <input type="tel" class="form-control" id="contactPhone" name="contactPhone"
                       placeholder="+32 4xx xx xx xx" />
              </div>
            </div>
          </div>

          <div class="col-12 d-grid mt-2">
            <button type="submit" class="btn btn-swipr-bedrijf btn-lg">
              Registreren
            </button>
          </div>

          <div class="col-12 text-center">
            <small class="text-muted">
              Al een account?
              <a href="/login_bedrijf" class="text-decoration-none fw-semibold text-swipr-bedrijf">Log in</a>
            </small>
          </div>

        </div>
      </form>

    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('registerForm');
    const vatInput = document.getElementById('vatNumber');
    const emailInput = document.getElementById('email');

    const vatPattern = /^BE\d{10}$/i;
    const forbiddenDomains = new Set(["gmail.com", "hotmail.com", "outlook.com", "yahoo.com"]);


    function markValid(input) {
      input.classList.remove('is-invalid');
      input.classList.add('is-valid');
      input.setCustomValidity('');
    }
    function markInvalid(input, message) {
      input.classList.remove('is-valid');
      input.classList.add('is-invalid');
      input.setCustomValidity(message || 'invalid');
    }

    function validateVat() {
      const v = vatInput.value.trim();
      if (!vatPattern.test(v)) {
        markInvalid(vatInput, "Ongeldig BTW-nummer");
        return false;
      }
      markValid(vatInput);
      return true;
    }

    function validateEmail() {
  const v = (emailInput.value || '').trim().toLowerCase();

  // eerst basis email check (HTML5)
  if (!emailInput.checkValidity()) {
    markInvalid(emailInput, "Ongeldig e-mailadres");
    return false;
  }

  // domein uit e-mail halen
  const parts = v.split("@");
  if (parts.length !== 2) {
    markInvalid(emailInput, "Ongeldig e-mailadres");
    return false;
  }

  const domain = parts[1].trim();

  // enkel blokkeren als domein exact een gratis provider is
  if (forbiddenDomains.has(domain)) {
    markInvalid(emailInput, "Gebruik een professioneel bedrijfsdomein");
    return false;
  }

  markValid(emailInput);
  return true;
}


    vatInput.addEventListener('input', () => {
      if (vatInput.value.trim().length >= 2) validateVat();
      else vatInput.classList.remove('is-valid', 'is-invalid');
    });

    emailInput.addEventListener('input', () => {
      if (emailInput.value.trim().length >= 3) validateEmail();
      else emailInput.classList.remove('is-valid', 'is-invalid');
    });

    form.addEventListener('submit', function (e) {
      let ok = true;

      if (!form.checkValidity()) ok = false;
      if (!validateVat()) ok = false;
      if (!validateEmail()) ok = false;

      if (!ok) {
        e.preventDefault();
        e.stopPropagation();
      }

      form.classList.add('was-validated');
    });
  })();
</script>

{% endblock %}

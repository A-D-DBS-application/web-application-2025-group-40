{% extends "base.html" %}

{% block title %}Swipr - Registratie Bedrijf{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center min-vh-100 py-5">
  <div class="card shadow-sm w-100" style="max-width: 560px;">
    <div class="card-body p-4 p-md-5">

      <div class="d-flex align-items-center gap-2 mb-3">
        <span class="d-inline-flex align-items-center justify-content-center rounded"
              style="width:32px;height:32px;background:#ff4b5c;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg">
            <path d="M5 12h12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M13 6l6 6-6 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <div class="fw-bold" style="color:#ff4b5c;">Swipr</div>
      </div>

      <h1 class="h4 fw-bold mb-1" style="color:#ff4b5c;">Registratie Bedrijf</h1>
      <p class="text-muted mb-4">Maak een bedrijfsaccount aan.</p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{% if category == 'danger' %}danger{% elif category == 'success' %}success{% else %}warning{% endif %} mb-3">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="registerForm" method="POST" action="{{ url_for('registratie_bedrijf') }}" novalidate>
        <div class="row g-3">

          <div class="col-12">
            <label for="companyName" class="form-label fw-semibold">Bedrijfsnaam</label>
            <input type="text" class="form-control" id="companyName" name="companyName"
                   placeholder="Naam van het bedrijf" required />
            <div class="invalid-feedback">Vul de bedrijfsnaam in.</div>
          </div>

          <div class="col-12">
            <label for="vatNumber" class="form-label fw-semibold">BTW-nummer</label>
            <input type="text" class="form-control" id="vatNumber" name="vatNumber"
                   placeholder="BE0123456789" required />
            <div class="invalid-feedback" id="vatErrorBs">BTW-nummer moet beginnen met 'BE' gevolgd door 10 cijfers.</div>
            <div class="form-text">Formaat: BE + 10 cijfers</div>
          </div>

          <div class="col-12">
            <label for="email" class="form-label fw-semibold">Zakelijke e-mail</label>
            <input type="email" class="form-control" id="email" name="email"
                   placeholder="bv. info@bedrijf.be" required />
            <div class="invalid-feedback" id="emailErrorBs">Gebruik een professioneel bedrijfsdomein (geen gratis provider).</div>
          </div>

          <div class="col-12">
            <label for="password" class="form-label fw-semibold">Wachtwoord</label>
            <input type="password" class="form-control" id="password" name="password"
                   placeholder="Kies een wachtwoord" required />
            <div class="invalid-feedback">Vul een wachtwoord in.</div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Contactpersoon</label>
            <div class="row g-2">
              <div class="col-12 col-md-7">
                <input type="text" class="form-control" id="contactName" name="contactName"
                       placeholder="Voornaam Achternaam" required />
                <div class="invalid-feedback">Vul de contactpersoon in.</div>
              </div>
              <div class="col-12 col-md-5">
                <input type="tel" class="form-control" id="contactPhone" name="contactPhone"
                       placeholder="+32 4xx xx xx xx" />
              </div>
            </div>
          </div>

          <div class="col-12 d-grid mt-2">
            <button type="submit" class="btn btn-danger btn-lg">Registreren</button>
          </div>

          <div class="col-12 text-center">
            <small class="text-muted">
              Al een account? <a href="/login_bedrijf" class="text-decoration-none" style="color:#ff4b5c;">Log in</a>
            </small>
          </div>

        </div>
      </form>

    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('registerForm');
    const vatInput = document.getElementById('vatNumber');
    const emailInput = document.getElementById('email');

    const vatPattern = /^BE\d{10}$/;
    const forbiddenDomains = ["gmail.com", "hotmail.com", "outlook.com", "yahoo.com"];

    function markValid(input) {
      input.classList.remove('is-invalid');
      input.classList.add('is-valid');
      input.setCustomValidity('');
    }
    function markInvalid(input, message) {
      input.classList.remove('is-valid');
      input.classList.add('is-invalid');
      input.setCustomValidity(message || 'invalid');
    }

    function validateVat() {
      const v = vatInput.value.trim();
      if (!vatPattern.test(v)) {
        markInvalid(vatInput, "Ongeldig BTW-nummer");
        return false;
      }
      markValid(vatInput);
      return true;
    }

    function validateEmail() {
      const v = (emailInput.value || '').toLowerCase().trim();
      const isForbidden = forbiddenDomains.some(domain => v.endsWith("@" + domain));
      if (isForbidden) {
        markInvalid(emailInput, "Ongeldig e-mailadres");
        return false;
      }
      // native email validity also matters
      if (!emailInput.checkValidity()) {
        markInvalid(emailInput, "Ongeldig e-mailadres");
        return false;
      }
      markValid(emailInput);
      return true;
    }

    vatInput.addEventListener('input', () => {
      // only auto-validate when user started typing something
      if (vatInput.value.trim().length >= 2) validateVat();
      else vatInput.classList.remove('is-valid', 'is-invalid');
    });

    emailInput.addEventListener('input', () => {
      if (emailInput.value.trim().length >= 3) validateEmail();
      else emailInput.classList.remove('is-valid', 'is-invalid');
    });

    form.addEventListener('submit', function (e) {
      // Bootstrap-like validation flow
      let ok = true;

      // trigger native validation UI state
      if (!form.checkValidity()) ok = false;

      // custom checks
      if (!validateVat()) ok = false;
      if (!validateEmail()) ok = false;

      if (!ok) {
        e.preventDefault();
        e.stopPropagation();
      }

      form.classList.add('was-validated');
    });
  })();
</script>
{% endblock %}

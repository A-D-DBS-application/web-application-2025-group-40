{% extends "base.html" %}

{% block title %}Recruiter Dashboard — Swipr{% endblock %}

{% block content %}

<!-- ===== NAVBAR ===== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-danger d-flex align-items-center gap-2" href="/recruiter_dashboard">
      <span class="d-inline-flex align-items-center justify-content-center rounded"
            style="width:32px;height:32px;background:#ff4b5c;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             xmlns="http://www.w3.org/2000/svg">
          <path d="M5 12h12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M13 6l6 6-6 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
      Swipr
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
            aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-3">
        <li class="nav-item">
          <a class="nav-link" href="/recruiter_profiel">Mijn profiel</a>
        </li>
        <li class="nav-item">
          <a class="btn btn-outline-secondary btn-sm" href="/logout">Uitloggen</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- ===== CONTENT ===== -->
<div class="container py-5">

  <!-- Welcome banner -->
  <div class="card border-0 shadow-sm mb-4"
       style="background:#ff4b5c;">
    <div class="card-body text-white p-4">
      <h1 class="h4 fw-bold mb-1">Welkom bij Swipr</h1>
      <p class="mb-0 opacity-75">Beheer uw vacatures en matches</p>
    </div>
  </div>

  <!-- Stats -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Actieve vacatures</div>
          <div class="display-6 fw-bold text-danger">{{ stats.active_job_count }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Totaal matches</div>
          <div class="display-6 fw-bold text-danger">{{ stats.total_matches }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Recente matches (laatste 7 dagen)</div>
          <div class="display-6 fw-bold text-danger">{{ stats.matches_last_7_days }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Jobs -->
  <div class="card shadow-sm">
    <div class="card-body p-4">

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
        <h2 class="h5 fw-bold mb-0">Mijn vacatures</h2>
        <a href="/vacature/nieuw" class="btn btn-danger">
          + Nieuwe vacature
        </a>
      </div>

      {% if jobs and jobs|length > 0 %}
        <div class="list-group">
          {% for job in jobs %}
            <div id="job-{{ job.id }}" class="list-group-item list-group-item-action">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div class="flex-grow-1">
                  <h3 class="h6 fw-bold mb-1">
                    {{ job.title }}{% if job.client %} – {{ job.client }}{% endif %}
                  </h3>
                  <div class="text-muted small">{{ job.location }}</div>

                  {% if job.description %}
                    <p class="mb-0 mt-2 text-body">
                      {{ job.description }}
                    </p>
                  {% endif %}
                </div>

                <div class="d-flex align-items-center gap-2">
                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm"
                    onclick="viewLikes({{ job.id }})"
                    title="Matches"
                    data-job-id="{{ job.id }}"
                  >
                    {% set cnt = job.matches|length %}
                    <span class="match-count">{{ cnt }}</span>
                    <span class="match-label">{% if cnt == 1 %}Match{% else %}Matches{% endif %}</span>
                  </button>

                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm"
                    onclick="confirmDelete({{ job.id }})"
                    title="Verwijderen"
                    aria-label="Verwijderen"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v7a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5.5a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0V6Zm2 .5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Z"/>
                      <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1Zm-3.5 1H5v9a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V4ZM2.5 2v1h11V2h-11Z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted mb-0">Geen vacatures geplaatst.</p>
      {% endif %}

    </div>
  </div>

</div>

<script>
  // Small toast helper
  function showToast(message, type = 'success', timeout = 2200) {
    const id = `toast-${Date.now()}`;
    const node = document.createElement('div');
    node.id = id;
    node.className = 'position-fixed bottom-0 end-0 p-3';
    node.style.zIndex = 1080;

    const alert = document.createElement('div');
    alert.className = `alert ${type === 'error' ? 'alert-danger' : 'alert-secondary'} shadow-sm mb-0`;
    alert.textContent = message;

    node.appendChild(alert);
    document.body.appendChild(node);

    setTimeout(() => {
      const n = document.getElementById(id);
      if (n) n.remove();
    }, timeout);
  }

  // Undoable delete (deactivate immediately, then hard delete after 5s unless undone)
  const pendingDeletes = {};

  async function confirmDelete(jobId) {
    if (!confirm('Weet je zeker dat je deze vacature wilt verwijderen?')) return;

    const el = document.getElementById(`job-${jobId}`);
    if (!el) return;

    const clone = el.cloneNode(true);
    el.style.display = 'none';

    // deactivate on server so students don't see it
    try {
      const decRes = await fetch(`/jobs/${jobId}/deactivate`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (!decRes.ok) {
        el.style.display = '';
        showToast('Fout bij verwijderen (deactiveren mislukt)', 'error');
        return;
      }
    } catch (err) {
      el.style.display = '';
      showToast('Netwerkfout bij verwijderen', 'error');
      return;
    }

    // update "Actieve vacatures" stat (first stat)
    const statEls = document.querySelectorAll('.display-6.fw-bold.text-danger');
    const activeStat = statEls && statEls.length > 0 ? statEls[0] : null;
    let activeWas = null;
    if (activeStat && !isNaN(parseInt(activeStat.textContent))) {
      activeWas = parseInt(activeStat.textContent);
      activeStat.textContent = Math.max(0, activeWas - 1);
    }

    // create undo toast
    const toastId = `delete-toast-${jobId}`;
    let toast = document.getElementById(toastId);
    if (toast) toast.remove();

    toast = document.createElement('div');
    toast.id = toastId;
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = 1080;
    toast.innerHTML = `
      <div class="alert alert-light border shadow-sm d-flex align-items-center gap-3 mb-0">
        <div class="small text-dark mb-0">Vacature verwijderd</div>
        <button class="btn btn-outline-secondary btn-sm" id="undo-${jobId}">Ongedaan</button>
      </div>
    `;
    document.body.appendChild(toast);

    const timeoutHandle = setTimeout(async () => {
      try {
        const res = await fetch(`/jobs/${jobId}/delete`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) {
          // restore UI on failure
          if (el && el.parentNode) el.style.display = '';
          else {
            const list = document.querySelector('.list-group');
            if (list) list.appendChild(clone);
          }
          if (activeStat && activeWas !== null) activeStat.textContent = activeWas;

          let msg = 'Fout bij verwijderen';
          try { const body = await res.json(); msg = body.error || msg; } catch(e) {}
          showToast(msg, 'error');
        }
      } catch (err) {
        if (el && el.parentNode) el.style.display = '';
        else {
          const list = document.querySelector('.list-group');
          if (list) list.appendChild(clone);
        }
        if (activeStat && activeWas !== null) activeStat.textContent = activeWas;
        showToast('Fout bij verwijderen (netwerkfout)', 'error');
      } finally {
        const t = document.getElementById(toastId);
        if (t) t.remove();
        delete pendingDeletes[jobId];
      }
    }, 5000);

    pendingDeletes[jobId] = { timeout: timeoutHandle, clone, activeWas };

    document.getElementById(`undo-${jobId}`).addEventListener('click', async () => {
      const pd = pendingDeletes[jobId];
      if (!pd) return;
      clearTimeout(pd.timeout);

      try {
        const res = await fetch(`/jobs/${jobId}/restore`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) {
          let msg = 'Fout bij herstellen';
          try { const body = await res.json(); msg = body.error || msg; } catch(e) {}
          showToast(msg, 'error');
          return;
        }
      } catch (err) {
        showToast('Netwerkfout bij herstellen', 'error');
        return;
      }

      if (el && el.parentNode) el.style.display = '';
      else {
        const list = document.querySelector('.list-group');
        if (list && pd.clone) list.appendChild(pd.clone);
      }

      if (activeStat && pd.activeWas !== null) activeStat.textContent = pd.activeWas;

      const t = document.getElementById(toastId);
      if (t) t.remove();
      delete pendingDeletes[jobId];
    });
  }

  async function viewLikes(jobId) {
    try {
      const res = await fetch(`/jobs/${jobId}/likes`, { credentials: 'same-origin' });
      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        showToast(body.error || 'Kan likes niet ophalen', 'error');
        return;
      }
      const data = await res.json();

      // Bootstrap-like modal (simple)
      const existing = document.getElementById('likesModal');
      if (existing) existing.remove();

      let html = `
        <div class="modal fade show" id="likesModal" tabindex="-1" style="display:block;" aria-modal="true" role="dialog">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Likes voor: ${data.title}</h5>
                <button type="button" class="btn-close" aria-label="Close" id="closeLikesX"></button>
              </div>
              <div class="modal-body">
      `;

      if (!data.likes || data.likes.length === 0) {
        html += `<p class="text-muted mb-0">Geen likes</p>`;
      } else {
        html += `<ul class="list-group">`;
        data.likes.forEach(l => {
          html += `
            <li class="list-group-item">
              <div class="fw-semibold">${(l.name || l.email)}</div>
              <div class="text-muted small">${l.email}</div>
            </li>`;
        });
        html += `</ul>`;
      }

      html += `
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="closeLikesBtn">Sluiten</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-backdrop fade show" id="likesBackdrop"></div>
      `;

      document.body.insertAdjacentHTML('beforeend', html);

      const close = () => {
        const m = document.getElementById('likesModal');
        const b = document.getElementById('likesBackdrop');
        if (m) m.remove();
        if (b) b.remove();
      };

      document.getElementById('closeLikesBtn').addEventListener('click', close);
      document.getElementById('closeLikesX').addEventListener('click', close);
      document.getElementById('likesBackdrop').addEventListener('click', close);

    } catch (err) {
      console.error(err);
      showToast('Fout bij ophalen likes', 'error');
    }
  }

  // Polling: refresh match counts
  const pollInterval = 5000;

  async function pollMatchCounts() {
    try {
      const res = await fetch('/recruiter/job_counts', { credentials: 'same-origin' });
      if (!res.ok) return;
      const data = await res.json();
      if (!data || !data.counts) return;

      Object.keys(data.counts).forEach(id => {
        const count = data.counts[id];
        const btn = document.querySelector(`[data-job-id='${id}']`);
        if (btn) {
          const span = btn.querySelector('.match-count');
          const label = btn.querySelector('.match-label');
          if (span) span.textContent = count;
          if (label) label.textContent = (count === 1) ? 'Match' : 'Matches';
        }
      });

      // update total matches stat (second stat)
      const statEls = document.querySelectorAll('.display-6.fw-bold.text-danger');
      const totalStat = statEls && statEls.length > 1 ? statEls[1] : null;
      if (totalStat && data.total_matches !== undefined) totalStat.textContent = data.total_matches;

    } catch (err) {
      // ignore
    }
  }

  window.addEventListener('load', () => {
    pollMatchCounts();
    setInterval(pollMatchCounts, pollInterval);
  });
</script>

{% endblock %}

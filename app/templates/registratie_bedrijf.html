{% extends "base.html" %}

{% block title %}Swipr - Registratie Bedrijf{% endblock %}

{% block content %}

{% from '_navbar.html' import navbar %}

{{ navbar(
  variant='bedrijf',
  show_brand=True,
  links=[],
  right_buttons=[{'href':'/login_bedrijf','label':'Log in','style':'outline'}]
) }}

<div class="container d-flex justify-content-center align-items-center min-vh-100 py-5">
  <div class="card shadow-sm w-100 swipr-auth-card">
    <div class="card-body p-4 p-md-5">

      <h1 class="h4 fw-bold text-swipr-bedrijf mb-1">Registratie Bedrijf</h1>
      <p class="text-muted mb-4">Maak een bedrijfsaccount aan.</p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{% if category == 'danger' %}danger{% elif category == 'success' %}success{% else %}warning{% endif %} mb-3">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="registerForm" method="POST" action="{{ url_for('registratie_bedrijf') }}" novalidate>
        <div class="row g-3">

          <div class="col-12">
            <label class="form-label fw-semibold">Bedrijfsnaam</label>
            <input type="text" class="form-control" name="companyName" required>
            <div class="invalid-feedback">Vul de bedrijfsnaam in.</div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">BTW-nummer</label>
            <input type="text" class="form-control" id="vatNumber" name="vatNumber" required>
            <div class="invalid-feedback">BTW-nummer moet beginnen met BE + 10 cijfers.</div>
            <div class="form-text">Formaat: BE + 10 cijfers</div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Zakelijke e-mail</label>
            <input type="email" class="form-control" id="email" name="email" required>
            <div class="invalid-feedback">
              Gebruik een professioneel bedrijfsdomein (geen gratis provider).
            </div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Wachtwoord</label>
            <input type="password" class="form-control" name="password" required>
            <div class="invalid-feedback">Vul een wachtwoord in.</div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Contactpersoon</label>
            <div class="row g-2">
              <div class="col-md-7">
                <input type="text" class="form-control" name="contactName" required>
                <div class="invalid-feedback">Vul de contactpersoon in.</div>
              </div>
              <div class="col-md-5">
                <input type="tel" class="form-control" name="contactPhone">
              </div>
            </div>
          </div>

          <div class="col-12 d-grid mt-2">
            <button type="submit" class="btn btn-swipr-bedrijf btn-lg">Registreren</button>
          </div>

        </div>
      </form>

    </div>
  </div>
</div>

<script>
(function () {
  const form = document.getElementById('registerForm');
  const vatInput = document.getElementById('vatNumber');
  const emailInput = document.getElementById('email');

  const vatPattern = /^BE\d{10}$/i;
  const forbiddenDomains = new Set([
    "gmail.com",
    "hotmail.com",
    "outlook.com",
    "yahoo.com"
  ]);

  function markValid(input) {
    input.classList.remove('is-invalid');
    input.classList.add('is-valid');
    input.setCustomValidity('');
  }

  function markInvalid(input, message) {
    input.classList.remove('is-valid');
    input.classList.add('is-invalid');
    input.setCustomValidity(message);
  }

  function validateVat() {
    vatInput.setCustomValidity('');
    if (!vatPattern.test(vatInput.value.trim())) {
      markInvalid(vatInput, "Ongeldig BTW-nummer");
      return false;
    }
    markValid(vatInput);
    return true;
  }

  function validateEmail() {
    emailInput.setCustomValidity('');
    const value = emailInput.value.trim().toLowerCase();

    if (!value) {
      emailInput.classList.remove('is-valid', 'is-invalid');
      return false;
    }

    if (emailInput.validity.typeMismatch) {
      markInvalid(emailInput, "Ongeldig e-mailadres");
      return false;
    }

    const domain = value.split('@')[1];
    if (!domain || forbiddenDomains.has(domain)) {
      markInvalid(emailInput, "Gebruik een professioneel bedrijfsdomein");
      return false;
    }

    markValid(emailInput);
    return true;
  }

  vatInput.addEventListener('input', validateVat);
  emailInput.addEventListener('input', validateEmail);

  form.addEventListener('submit', function (e) {
    let ok = true;
    if (!form.checkValidity()) ok = false;
    if (!validateVat()) ok = false;
    if (!validateEmail()) ok = false;

    if (!ok) {
      e.preventDefault();
      e.stopPropagation();
    }

    form.classList.add('was-validated');
  });
})();
</script>

{% endblock %}
